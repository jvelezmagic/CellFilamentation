---
title: "Experiment Data Exploration"
author: "Jesús Vélez Santiago"
date: "`r format(Sys.Date(), '%Y-%m')`"
output: 
  html_document:
    theme: readable
    highlight: kate
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: show
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  fig.align = "center",
  # dev = "svg",
  fig.retina = 2
)
```

## Libraries

```{r libraries, message=FALSE}
library(tidyverse)
library(ggpubr)
library(ggwaffle)
library(here)
library(glue)
```

## Load Data

```{r load_data}
lineages_files <- here("data", "processed", "lineages.tsv")
lineages_df <- read_tsv(lineages_files, show_col_types = FALSE) %>% 
  glimpse()
```

## Minimal preprocessing

```{r}
processed_lineages_df <- lineages_df %>% 
  mutate(
    gfp = log10(gfp),
    ds_red = log10(ds_red)
  ) %>% 
  add_count(experiment_id, trap_id, track_id, time) %>% 
  filter(n == 1) %>% 
  select(-n) %>% 
  glimpse()
```


## Exploratory Data Analysis

### Set default plot style

```{r default_plot_theme}
theme_set(ggpubr::theme_pubr())
```


```{r}

donout_df <- processed_lineages_df %>% 
  count(experiment_id, filamentaded_track) %>% 
  arrange(filamentaded_track) %>% 
  mutate(
    experiment_id = case_when(
      experiment_id == "Chromosome" ~ "C",
      TRUE ~ "P"
    ),
    percentage = n / sum(n) * 100,
    ymax = cumsum(percentage),
    ymin = c(0, head(ymax, -1)),
    label = glue("{experiment_id}: {format(percentage, digits=2)}%"),
    label_position = (ymax + ymin) / 2
  ) %>% 
  glimpse()

donout_total <- donout_df %>% 
  pull(n) %>% 
  sum()
  
donout_df %>% 
  ggplot(
    aes(
      ymax=ymax,
      ymin=ymin,
      xmax=4,
      xmin=3
    ),
  ) +
  geom_rect(
    size = 1.5,
    color = "white",
    aes(
      fill=filamentaded_track,
      group=experiment_id
      )
  ) +
  geom_label(x = 2, aes(y = label_position, label = label), size=3.5) +
  coord_polar(theta = "y") +
  xlim(c(-1, 4)) +
  labs(
    fill = "Filamentaded track",
    caption = glue("Total: {format(donout_total, big.mark=',')} tracks")
  ) +
  theme_void() +
  theme(
    legend.position = "top",
    plot.caption = element_text(face = "bold", hjust = 0.5)
  )
```


### Mean GFP
```{r}
processed_lineages_df %>% 
  group_by(experiment_id, trap_id, track_id, filamentaded_track) %>% 
  summarize(mean_gfp = mean(gfp), .groups = "drop") %>%
  gghistogram(
    x = "mean_gfp",
    facet.by = "experiment_id",
    color = "filamentaded_track",
    fill = "filamentaded_track",
    alpha = 1/3,
    add = "mean",
    xlab = "Mean fluorescent intensity (log10)",
    ylab = "Count of cells"
  ) +
  labs(
    color = "Filamentaded cell",
    fill = "Filamentaded cell"
  )
```

```{r}
processed_lineages_df %>%
  ggplot() +
  annotate("rect", xmin=60, xmax=140, ymin=-Inf, ymax=Inf, alpha=1/2, color = "transparent", fill = "#FCB565") +
  geom_density(
    aes(
      x = time,
      color = filamentaded_at_frame,
      fill = filamentaded_at_frame
    ),
    alpha = 1/2
  ) +
  facet_wrap(. ~ experiment_id) +
  #scale_y_continuous(labels = scales::percent) +
  labs(
    x = "Time (minutes)",
    y = "Density",
    color = "Filamentaded cell",
    fill = "Filamentaded cell"
  ) +
  theme_bw() +
  theme(legend.position = "top")
```

```{r}
processed_lineages_df %>% 
  count(experiment_id, filamentaded_at_frame, time) %>% 
  group_by(experiment_id, time) %>% 
  summarize(
    filamentaded_at_frame = filamentaded_at_frame,
    percentage = n / sum(n),
    .groups = "drop"
  ) %>% 
  ggplot(aes(x = time, y = percentage, fill = filamentaded_at_frame)) +
  geom_area(size = 0.5, alpha = 1/2) +
  geom_vline(xintercept = c(60, 140), linetype = "dashed") +
  geom_text(
    data = data.frame(
      x = 73,
      y = 0.8,
      label = "Start",
      experiment_id = "Plasmid"
    ),
    mapping = aes(x = x, y = y, label = label),
    size = 5.64,
    colour = "white",
    fontface = 2,
    inherit.aes = FALSE
  ) +
  geom_text(
    data = data.frame(
      x = 151,
      y = 0.8,
      label = "End",
      experiment_id = "Plasmid"
    ),
    mapping = aes(x = x, y = y, label = label),
    size = 5.64,
    colour = "white",
    fontface = 2,
    inherit.aes = FALSE
  ) +
  facet_grid(experiment_id ~ .) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0), labels = scales::percent) +
  theme_bw() +
  theme(
    legend.position = "top",
    panel.spacing.y = unit(1, "lines")
  ) +
  labs(
    x = "Time (minutes)",
    y = "Percentage of cells",
    fill = "Filamentaded cell"
  )
```

```{r}
library(ggdist)

processed_lineages_df %>% 
  filter(time == 0) %>% 
  #filter(metric != "length") %>% 
  ggplot(
    aes(
      x = filamentaded_track,
      y = length,
      group = filamentaded_track,
      fill = filamentaded_track,
      color = filamentaded_track
    )
  ) +
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .6, 
    .width = 0, 
    justification = -.2,
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .15,
    outlier.shape = NA,
    alpha = 1/3
  ) +
  geom_point(
    size = 0.8,
    alpha = 0.01,
    position = position_jitter(
      seed = 1, width = .01
    )
  ) + 
  facet_wrap(experiment_id ~ .) +
  theme_bw() +
  theme(legend.position = "top") +
  labs(
    x = "Filamentaded track",
    y = "Initial length",
    color = "Filamentaded track",
    fill = "Filamentaded track"
  ) +
  scale_y_continuous(limits = c(0, 100)) +
  coord_flip()


processed_lineages_df %>% 
  filter(time == 0) %>% 
  #filter(metric != "length") %>% 
  ggplot(
    aes(
      x = filamentaded_track,
      y = gfp,
      group = filamentaded_track,
      fill = filamentaded_track,
      color = filamentaded_track
    )
  ) +
  ggdist::stat_halfeye(
    adjust = .5, 
    width = .6, 
    .width = 0, 
    justification = -.2,
    point_colour = NA
  ) + 
  geom_boxplot(
    width = .15,
    outlier.shape = NA,
    alpha = 1/3
  ) +
  geom_point(
    size = 0.8,
    alpha = 0.01,
    position = position_jitter(
      seed = 1, width = .01
    )
  ) + 
  facet_wrap(experiment_id ~ .) +
  theme_bw() +
  theme(legend.position = "top") +
  labs(
    x = "Filamentaded track",
    y = "Initial GFP",
    color = "Filamentaded track",
    fill = "Filamentaded track"
  ) +
  #scale_y_continuous(limits = c(0, 100)) +
  coord_flip()
```

```{r}
processed_lineages_df %>% 
  select(experiment_id, filamentaded_track, time, length, gfp, ds_red) %>% 
  pivot_longer(
    cols = c(length, gfp, ds_red),
    names_to = "metric"
  ) %>%
  mutate(
    metric = case_when(
      metric == "ds_red" ~ "DsRed",
      metric == "gfp" ~ "GFP",
      metric == "length" ~ "Length"
    )
  ) %>% 
  group_by(experiment_id, filamentaded_track, time, metric) %>%
  summarise(
    ci = list(mean_cl_normal(value)),
    .groups = "drop"
  ) %>% 
  unnest(cols = c(ci)) %>% 
  ggplot(aes(x = time, y = y, ymin= ymin, ymax=ymax, color = filamentaded_track)) +
  annotate("rect", xmin=60, xmax=140, ymin=-Inf, ymax=Inf, alpha=1/2, color = "transparent", fill = "#FCB565") +
  geom_smooth(method = "loess") +
  facet_grid(metric ~ experiment_id, scales = "free_y") +
  labs(
    x = "Time (minutes)",
    y = "Value",
    color = "Filamentaded track"
  ) +
  theme_bw() +
  theme(legend.position = "top")
```

